<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Цилиндр с числами — Минималка</title>
  <style>
    /* Стили опущены для краткости — скопируйте их из предыдущего примера */
  </style>
</head>
<body>

  <div id="score">Очки: 0</div>
  <div class="cylinder-container">
    <div id="cylinder"></div>
  </div>

  <div class="btns">
    <button id="shop-btn">Магазин</button>
    <button id="tasks-btn">Задания</button>
    <button id="invite-btn">Пригласить</button>
  </div>

  <!-- Магазин -->
  <div id="shop-overlay" class="overlay">
    <div class="overlay-content">
      <h2>Магазин</h2>
      <ul id="shop-list"></ul>
      <button id="close-shop" class="close-btn">Закрыть</button>
    </div>
  </div>

  <!-- Задания -->
  <div id="tasks-overlay" class="overlay">
    <div class="overlay-content">
      <h2>Задания</h2>
      <p>Пока пусто</p>
      <button id="close-tasks" class="close-btn">Закрыть</button>
    </div>
  </div>

  <!-- Приглашение -->
  <div id="invite-overlay" class="overlay">
    <div class="overlay-content">
      <h2>Приглашай друзей</h2>
      <div id="referral-container"></div>
      <button id="close-invite" class="close-btn">Закрыть</button>
    </div>
  </div>

  <script>
  (() => {
    const BOT_USERNAME = 'YourBotUsername'; // <- Замените на имя вашего Telegram-бота

    const cylinder = document.getElementById('cylinder');
    const scoreDisplay = document.getElementById('score');
    const cpsDisplay = document.createElement('div');
    cpsDisplay.style.cssText = 'font-size:1.2rem;margin-bottom:15px;text-shadow:0 0 5px rgba(0,0,0,.5);';
    scoreDisplay.insertAdjacentElement('afterend', cpsDisplay);

    const shopBtn = document.getElementById('shop-btn');
    const tasksBtn = document.getElementById('tasks-btn');
    const inviteBtn = document.getElementById('invite-btn');
    const shopOverlay = document.getElementById('shop-overlay');
    const tasksOverlay = document.getElementById('tasks-overlay');
    const inviteOverlay = document.getElementById('invite-overlay');
    const closeShopBtn = document.getElementById('close-shop');
    const closeTasksBtn = document.getElementById('close-tasks');
    const closeInviteBtn = document.getElementById('close-invite');
    const referralContainer = document.getElementById('referral-container');
    const shopList = document.getElementById('shop-list');

    let score = parseInt(localStorage.getItem('score')) || 0;
    let activeFace = null;
    const numbers = [1,2,3,4,5,6,7,8];
    const radius = 80;
    const angleStep = 360 / numbers.length;

    let autoClickerActive = localStorage.getItem('autoClickerActive') === 'true';
    let doublePointsActive = localStorage.getItem('doublePointsActive') === 'true';

    const REFERRAL_BONUS = 2000000;

    function getUserId() {
      let id = localStorage.getItem('userId');
      if (!id) {
        id = 'user-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', id);
      }
      return id;
    }

    function getReferralFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('ref');
    }

    function applyReferralBonus(ref) {
      const used = localStorage.getItem('usedReferral');
      if (used) return;
      if (ref && ref !== localStorage.getItem('userId')) {
        score += REFERRAL_BONUS;
        localStorage.setItem('usedReferral', ref);
        localStorage.setItem('score', score);
        alert(`Ты получил бонус ${REFERRAL_BONUS.toLocaleString()} очков за приглашение!`);
      }
    }

    const userId = getUserId();
    applyReferralBonus(getReferralFromURL());

    function getAutoClickerLevel() {
      return parseInt(localStorage.getItem('autoClickerLevel')) || 0;
    }
    function getDoublePointsLevel() {
      return parseInt(localStorage.getItem('doublePointsLevel')) || 0;
    }

    function calculateCPS() {
      const lvl = getAutoClickerLevel();
      if (lvl === 0) return 0;
      const interval = Math.max(500,1500-lvl*100);
      return ((numbers.reduce((a,b)=>a+b,0)/numbers.length)*(getDoublePointsLevel()+1)*(1000/interval)).toFixed(1);
    }

    function updateScoreDisplay() {
      scoreDisplay.textContent = `Очки: ${score}`;
      cpsDisplay.textContent = `Очки в секунду: ${calculateCPS()}`;
    }

    function handleOffline() {
      const last = parseInt(localStorage.getItem('lastVisit'))||Date.now();
      const now = Date.now(), diffSec=Math.floor((now-last)/1000);
      const lvl=getAutoClickerLevel(), dbl=getDoublePointsLevel();
      if (autoClickerActive && lvl>0 && diffSec>0) {
        const interval = Math.max(500,1500-lvl*100);
        const clicks = Math.floor(diffSec*1000/interval);
        let pts=0;
        for (let i=0;i<clicks;i++) pts += numbers[Math.floor(Math.random()*numbers.length)]*(dbl+1);
        score+=pts;
        alert(`Вы были оффлайн ${diffSec} сек. Получено ${pts} очков`);
      }
      localStorage.setItem('lastVisit', now);
      localStorage.setItem('score', score);
      updateScoreDisplay();
    }

    numbers.forEach((num,i)=>{
      const f = document.createElement('div');
      f.className='face';
      f.textContent=num;
      f.style.transform=`rotateY(${i*angleStep}deg) translateZ(${radius}px)`;
      f.onclick=()=>{
        if(activeFace) activeFace.classList.remove('active');
        f.classList.add('active');
        activeFace=f;
        score += num * (getDoublePointsLevel()+1);
        localStorage.setItem('score', score);
        updateScoreDisplay();
      };
      cylinder.appendChild(f);
    });

    const shopItems = [
      {id:'autoClicker',name:'Автокликер',basePrice:10},
      {id:'doublePoints',name:'Ускоритель x2+',basePrice:50}
    ];

    function renderShop(){
      shopList.innerHTML='';
      shopItems.forEach(item=>{
        const lvl=item.id==='autoClicker'?getAutoClickerLevel():getDoublePointsLevel();
        const price=Math.floor(item.basePrice*Math.pow(1.8,lvl));
        const li=document.createElement('li');
        li.textContent=`${item.name} (Ур. ${lvl}) — ${price} очков`;
        const btn=document.createElement('button');
        btn.textContent='Улучшить';
        btn.onclick=()=>buyItem(item.id);
        li.appendChild(btn);
        shopList.appendChild(li);
      });
    }

    function buyItem(id){
      const currLvl=id==='autoClicker'?getAutoClickerLevel():getDoublePointsLevel();
      const price=Math.floor(shopItems.find(i=>i.id===id).basePrice*Math.pow(1.8,currLvl));
      if(score<price){alert('Недостаточно очков!');return;}
      score-=price;
      if(id==='autoClicker'){
        localStorage.setItem('autoClickerLevel',currLvl+1);
        autoClickerActive = true;
        localStorage.setItem('autoClickerActive','true');
        restartAutoClicker();
      } else {
        localStorage.setItem('doublePointsLevel',currLvl+1);
        doublePointsActive = true;
        localStorage.setItem('doublePointsActive','true');
      }
      localStorage.setItem('score', score);
      updateScoreDisplay();renderShop();
    }

    let autoClickerInterval=null;
    function getAutoClickerInterval(){
      return Math.max(500,1500-getAutoClickerLevel()*100);
    }
    function restartAutoClicker(){
      if(autoClickerInterval) clearInterval(autoClickerInterval);
      startAutoClicker();
    }
    function startAutoClicker(){
      if(!autoClickerActive) return;
      autoClickerInterval = setInterval(()=>{
        const rnd = numbers[Math.floor(Math.random()*numbers.length)];
        score += rnd * (getDoublePointsLevel()+1);
        localStorage.setItem('score', score);
        updateScoreDisplay();
      }, getAutoClickerInterval());
    }
    if(autoClickerActive) startAutoClicker();

    function toggle(o,b){ o.classList.toggle('visible', b); }

    shopBtn.onclick=()=>{
      renderShop(); toggle(shopOverlay,true); toggle(tasksOverlay,false); toggle(inviteOverlay,false);
    };
    tasksBtn.onclick=()=>{
      toggle(tasksOverlay,true); toggle(shopOverlay,false); toggle(inviteOverlay,false);
    };
    inviteBtn.onclick=()=>{
      const link = `https://t.me/${BOT_USERNAME}?start=ref_${userId}`;
      referralContainer.innerHTML=`
        <p>Ваш реферальный бот‑линк:</p>
        <input type="text" value="${link}" readonly style="width:100%;padding:5px;font-size:1rem"/>
        <br><br><button id="copyReferralBtn">Скопировать</button>`;
      document.getElementById('copyReferralBtn').onclick=()=>{
        const inp=referralContainer.querySelector('input');
        inp.select(); document.execCommand('copy');
        alert('Ссылка скопирована!');
      };
      toggle(inviteOverlay,true); toggle(shopOverlay,false); toggle(tasksOverlay,false);
    };
    closeShopBtn.onclick = ()=>toggle(shopOverlay,false);
    closeTasksBtn.onclick = ()=>toggle(tasksOverlay,false);
    closeInviteBtn.onclick = ()=>toggle(inviteOverlay,false);

    handleOffline(); updateScoreDisplay();

    window.addEventListener('beforeunload', ()=>localStorage.setItem('lastVisit',Date.now()));
  })();
  </script>

</body>
</html>